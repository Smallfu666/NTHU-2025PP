# -----------------------------------------------------
# Compiler Settings
# -----------------------------------------------------
CC   = gcc
CXX  = g++
NVCC = nvcc
HIPCC = hipcc

# -----------------------------------------------------
# [CPU] HW3-1 Flags (完全依照你提供的規定)
# -----------------------------------------------------
CXXFLAGS = -O2 -pthread -fopenmp
LDFLAGS  = -lm

# -----------------------------------------------------
# [NVIDIA GPU] HW3-2, HW3-3 Flags
# -----------------------------------------------------
NVFLAGS = -std=c++11 -O3 -Xptxas="-v" -arch=sm_61 --use_fast_math -lineinfo

# Multi-GPU (OpenMP 控制 host side threads)
hw3-3: NVFLAGS += -Xcompiler="-fopenmp"

# -----------------------------------------------------
# [Optional AMD GPU Versions]
# -----------------------------------------------------
HIPCCFLAGS = -std=c++11 -O3 --offload-arch=gfx908

# -----------------------------------------------------
# Targets
# -----------------------------------------------------
EXES = hw3-1 hw3-2 hw3-3

.PHONY: all clean

# -----------------------------------------------------
# Default
# -----------------------------------------------------
all: $(EXES)

# -----------------------------------------------------
# HW3-1 (依照你給的規範)
# -----------------------------------------------------
hw3-1: hw3-1.cc
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@ $?

# Optional sequential version
seq: seq.cc
	$(CXX) $(CXXFLAGS) -o $@ $?

# -----------------------------------------------------
# HW3-2 (Single GPU)
# -----------------------------------------------------
hw3-2: hw3-2.cu
	$(NVCC) $(NVFLAGS) -o $@ $< $(LDFLAGS)

# -----------------------------------------------------
# HW3-3 (Multi-GPU)
# -----------------------------------------------------
hw3-3: hw3-3.cu
	$(NVCC) $(NVFLAGS) -o $@ $< $(LDFLAGS)

# -----------------------------------------------------
# Optional HIP Versions
# -----------------------------------------------------
hw3-2-amd: hw3-2.hip
	$(HIPCC) $(HIPCCFLAGS) -o $@ $< $(LDFLAGS)

hw3-3-amd: hw3-3.hip
	$(HIPCC) $(HIPCCFLAGS) -o $@ $< $(LDFLAGS)

# -----------------------------------------------------
# Clean
# -----------------------------------------------------
clean:
	rm -f $(EXES) seq hw3-2-amd hw3-3-amd